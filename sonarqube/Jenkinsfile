pipeline {
    agent any
    tools {
        // Asegúrate de que SonarQube está configurado en Jenkins
        sonar 'SonarQube Scanner'
    }
    environment {
        // Definir el sonar-scanner en el ambiente
        sonarqubeScannerHome = tool name: 'SonarQube Scanner', type: 'ToolProperty'
    }
    stages {
        stage('Prepare') {
            steps {
                script {
                    // Preparar el entorno antes de iniciar el análisis
                    sh 'docker pull gradle:jdk8-alpine'
                }
            }
        }
        stage('Build') {
            steps {
                script {
                    // Construcción del proyecto usando Gradle
                    sh '/opt/gradle/bin/gradle -p complete build'
                }
            }
        }
        stage('SonarQube Analysis') {
            steps {
                script {
                    // Ejecutar análisis de SonarQube
                    withCredentials([string(credentialsId: 'sonar', variable: 'sonarLogin')]) {
                        sh """
                            ${sonarqubeScannerHome}/bin/sonar-scanner \
                            -Dsonar.host.url=http://sonarqube:9000 \
                            -Dsonar.login=${sonarLogin} \
                            -Dsonar.projectName=tienda \
                            -Dsonar.projectVersion=${env.BUILD_NUMBER} \
                            -Dsonar.projectKey=TIENDA \
                            -Dsonar.sources=.,admin \
                            -Dsonar.java.binaries=build/classes \
                            -Dsonar.tests=
                        """
                    }
                }
            }
        }
    }
}


